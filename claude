<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Emmiti - A emmiti blog</title>
  <meta name="description" content="Single-file blog with Markdown + Admin (create/edit/delete)" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;600;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0a0f;
      --bg-secondary:#0f0f15;
      --panel:#14141c;
      --border:#1f1f2d;
      --text:#e5e7eb;
      --text-muted:#9ca3af;
      --accent:#c41e5e;
      --accent-hover:#a01850;
      --accent-dark:#8b1344;
      --red-accent:#b91c1c;
      --magenta-dark:#7d1745;
      --deep-blue:#0A2342;
      --muted-gold:#C6A667;
      --warm-grey:#7A7A7A;
      --burgundy:#58181F;
      --forest-green:#254D32;
      --radius:8px;
    }
    
    [data-theme="light"]{
      --bg:#f8f9fa;
      --bg-secondary:#ffffff;
      --panel:#ffffff;
      --border:#e5e7eb;
      --text:#1f2937;
      --text-muted:#6b7280;
    }
    
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Inter',system-ui,-apple-system,sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.6;
      transition:background 0.3s, color 0.3s;
    }
    
    .fade-in{
      opacity:0;
      transform:translateY(20px);
      animation:fadeInUp 0.6s ease forwards;
    }
    
    @keyframes fadeInUp{
      to{opacity:1;transform:translateY(0)}
    }
    
    header{
      background:var(--bg-secondary);
      border-bottom:2px solid var(--deep-blue);
      position:sticky;
      top:0;
      z-index:100;
      backdrop-filter:blur(10px);
    }
    
    .header-container{
      max-width:1200px;
      margin:0 auto;
      padding:1rem 1.5rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    
    #brand{
      display:flex;
      gap:0.75rem;
      align-items:center;
    }
    
    #logo{
      width:40px;
      height:40px;
      border-radius:6px;
      background:linear-gradient(135deg, var(--accent), var(--magenta-dark));
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-family:'Playfair Display',serif;
      font-size:22px;
      letter-spacing:-0.5px;
      color:#fff;
    }
    
    #site-title{
      font-family:'Playfair Display',serif;
      font-weight:700;
      font-size:1.5rem;
      letter-spacing:-0.5px;
      color:var(--text);
    }
    
    .small{
      font-size:0.875rem;
      color:var(--text-muted);
      font-weight:400;
    }
    
    nav{
      display:flex;
      gap:2rem;
      align-items:center;
    }
    
    nav a{
      color:var(--text-muted);
      text-decoration:none;
      font-weight:500;
      font-size:0.9375rem;
      transition:color 0.2s;
    }
    
    nav a:hover{
      color:var(--accent);
    }
    
    .theme-toggle{
      background:transparent;
      border:1px solid var(--border);
      color:var(--text);
      width:36px;
      height:36px;
      border-radius:50%;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.2s;
      font-size:1.2rem;
      padding:0;
    }
    
    .theme-toggle:hover{
      background:var(--panel);
      border-color:var(--accent);
    }
    
    .container{
      max-width:1200px;
      margin:0 auto;
      padding:3rem 1.5rem;
    }
    
    .hero{
      border-radius:var(--radius);
      overflow:hidden;
      background:var(--panel);
      border:2px solid var(--deep-blue);
      margin-bottom:3rem;
      position:relative;
      min-height:400px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    .hero-center{
      padding:3rem;
      position:relative;
      width:100%;
      text-align:center;
    }
    
    .hero-center::before{
      content:'';
      position:absolute;
      inset:0;
      background-size:cover;
      background-position:center;
      background-image:var(--bg-image);
      z-index:1;
      filter:blur(8px) brightness(0.3);
      transform:scale(1.05);
    }
    
    .hero-center > *{
      position:relative;
      z-index:2;
    }
    
    .hero-title{
      font-family:'Playfair Display',serif;
      font-size:3rem;
      font-weight:700;
      margin-bottom:1rem;
      line-height:1.2;
      letter-spacing:-1px;
    }
    
    .hero-sub{
      color:var(--text-muted);
      font-size:1.125rem;
      max-width:600px;
      margin:0 auto;
      line-height:1.6;
    }
    
    .tiles{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(350px,1fr));
      gap:2rem;
    }
    
    @media(max-width:768px){
      .tiles{
        grid-template-columns:1fr;
      }
      .hero-title{
        font-size:2rem;
      }
    }
    
    .tile{
      position:relative;
      height:320px;
      border-radius:var(--radius);
      overflow:hidden;
      background:var(--panel);
      cursor:pointer;
      border:1px solid var(--border);
      display:flex;
      align-items:flex-end;
      padding:1.5rem;
      transition:transform 0.3s,border-color 0.3s;
    }
    
    .tile:hover{
      transform:translateY(-4px);
      border-color:var(--accent);
    }
    
    .tile .bg{
      position:absolute;
      inset:0;
      background-size:cover;
      background-position:center;
      filter:brightness(0.4);
      transition:transform 0.6s,filter 0.3s;
    }
    
    .tile:hover .bg{
      filter:brightness(0.5);
      transform:scale(1.05);
    }
    
    .tile .meta{
      position:relative;
      z-index:2;
    }
    
    .tile h3{
      font-family:'Playfair Display',serif;
      font-size:1.5rem;
      font-weight:600;
      margin-bottom:0.5rem;
      line-height:1.3;
    }
    
    .tile p{
      color:var(--text-muted);
      font-size:0.875rem;
    }
    
    .badge{
      position:absolute;
      top:1rem;
      left:1rem;
      padding:0.25rem 0.75rem;
      border-radius:999px;
      font-weight:600;
      z-index:4;
      font-size:0.75rem;
      text-transform:uppercase;
      letter-spacing:0.5px;
      color:#fff;
    }
    
    .badge-new{
      background:linear-gradient(90deg, var(--red-accent), var(--accent));
    }
    
    .badge-featured{
      background:linear-gradient(90deg, var(--muted-gold), var(--burgundy));
    }
    
    .badge-series{
      background:linear-gradient(90deg, var(--deep-blue), var(--forest-green));
    }
    
    .reading-time{
      display:inline-flex;
      align-items:center;
      gap:0.25rem;
      color:var(--text-muted);
      font-size:0.875rem;
    }
    
    .post{
      background:var(--panel);
      padding:2rem;
      border-radius:var(--radius);
      border:1px solid var(--border);
      margin-top:2rem;
    }
    
    .post-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:2rem;
    }
    
    .post-header a{
      color:var(--text-muted);
      text-decoration:none;
      font-weight:500;
      transition:color 0.2s;
    }
    
    .post-header a:hover{
      color:var(--accent);
    }
    
    .post-cover{
      height:400px;
      border-radius:var(--radius);
      background-size:cover;
      background-position:center;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      margin-bottom:2rem;
      border:2px solid var(--deep-blue);
    }
    
    .post-cover::before{
      content:'';
      position:absolute;
      inset:0;
      background-size:cover;
      background-position:center;
      background-image:var(--post-bg-image);
      z-index:1;
      filter:blur(8px) brightness(0.3);
      transform:scale(1.03);
      border-radius:var(--radius);
    }
    
    .post-cover::after{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(180deg,rgba(0,0,0,0.1),rgba(0,0,0,0.5));
      border-radius:var(--radius);
      z-index:2;
    }
    
    .post h1{
      position:relative;
      z-index:3;
      margin:0;
      font-family:'Playfair Display',serif;
      font-size:2.5rem;
      font-weight:700;
      line-height:1.2;
      letter-spacing:-1px;
    }
    
    .post-meta{
      color:var(--text-muted);
      margin-bottom:2rem;
      font-size:0.9375rem;
      display:flex;
      align-items:center;
      gap:1rem;
      flex-wrap:wrap;
    }
    
    .share-buttons{
      display:flex;
      gap:0.5rem;
      margin:2rem 0;
      padding:1rem 0;
      border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);
    }
    
    .share-btn{
      padding:0.5rem 1rem;
      border-radius:var(--radius);
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      cursor:pointer;
      font-size:0.875rem;
      font-weight:500;
      transition:all 0.2s;
      display:flex;
      align-items:center;
      gap:0.5rem;
    }
    
    .share-btn:hover{
      background:var(--bg);
      border-color:var(--accent);
      color:var(--accent);
    }
    
    #post-content{
      max-width:750px;
      margin:0 auto;
    }
    
    #post-content h1,#post-content h2,#post-content h3{
      font-family:'Playfair Display',serif;
      margin:2rem 0 1rem;
      line-height:1.3;
      letter-spacing:-0.5px;
      color:var(--text);
    }
    
    #post-content h1{font-size:2rem}
    #post-content h2{font-size:1.75rem;border-bottom:2px solid var(--deep-blue);padding-bottom:0.5rem}
    #post-content h3{font-size:1.5rem}
    
    #post-content p{
      margin:1.25rem 0;
      line-height:1.7;
      font-size:1.0625rem;
    }
    
    #post-content a{
      color:var(--accent);
      text-decoration:none;
      border-bottom:1px solid transparent;
      transition:border-color 0.2s;
    }
    
    #post-content a:hover{
      border-bottom-color:var(--accent);
    }
    
    #post-content img{
      max-width:100%;
      border-radius:var(--radius);
      margin:1.5rem 0;
      border:1px solid var(--border);
    }
    
    #post-content code{
      background:var(--bg);
      padding:0.25rem 0.5rem;
      border-radius:4px;
      font-size:0.9em;
      font-family:monospace;
      border:1px solid var(--border);
    }
    
    #post-content pre{
      background:var(--bg);
      padding:1.5rem;
      border-radius:var(--radius);
      overflow-x:auto;
      margin:1.5rem 0;
      border:1px solid var(--deep-blue);
    }
    
    #post-content pre code{
      background:none;
      padding:0;
      border:none;
    }
    
    #post-content ul,#post-content ol{
      margin:1.25rem 0;
      padding-left:1.5rem;
    }
    
    #post-content li{
      margin:0.5rem 0;
    }
    
    #post-content blockquote{
      border-left:4px solid var(--muted-gold);
      padding-left:1.5rem;
      margin:1.5rem 0;
      font-style:italic;
      color:var(--text-muted);
    }
    
    .admin-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:2rem;
    }
    
    @media(min-width:990px){
      .admin-grid{
        grid-template-columns:2fr 1fr;
      }
    }
    
    .card{
      background:var(--panel);
      padding:2rem;
      border-radius:var(--radius);
      border:1px solid var(--border);
    }
    
    .card h3{
      font-family:'Playfair Display',serif;
      font-size:1.5rem;
      margin-bottom:0.5rem;
      color:var(--text);
    }
    
    .card-subtitle{
      color:var(--text-muted);
      font-size:0.9375rem;
      margin-bottom:1.5rem;
      padding-bottom:1rem;
      border-bottom:1px solid var(--border);
    }
    
    .post-list{
      list-style:none;
      padding:0;
      margin:0;
    }
    
    .post-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:1rem;
      border-radius:var(--radius);
      margin-bottom:0.75rem;
      background:var(--bg);
      border:1px solid var(--border);
      transition:border-color 0.2s;
    }
    
    .post-item:hover{
      border-color:var(--warm-grey);
    }
    
    .post-item .left{
      max-width:70%;
    }
    
    .controls{
      display:flex;
      gap:0.5rem;
    }
    
    .controls button{
      padding:0.5rem 1rem;
      border-radius:var(--radius);
      border:1px solid var(--border);
      cursor:pointer;
      font-weight:500;
      font-size:0.875rem;
      transition:all 0.2s;
      background:transparent;
      color:var(--text);
    }
    
    .controls button:hover{
      background:var(--bg);
    }
    
    .btn-mag{
      background:linear-gradient(135deg, var(--accent), var(--magenta-dark));
      color:#fff;
      border:none;
    }
    
    .btn-mag:hover{
      background:linear-gradient(135deg, var(--accent-hover), var(--accent-dark));
    }
    
    .btn-ghost{
      background:transparent;
      border:1px solid var(--border);
      color:var(--text);
    }
    
    .form-group{
      margin-bottom:1.5rem;
    }
    
    .form-group label{
      display:block;
      margin-bottom:0.5rem;
      font-weight:600;
      font-size:0.9375rem;
      color:var(--text);
    }
    
    .form-hint{
      font-size:0.8125rem;
      color:var(--warm-grey);
      margin-top:0.25rem;
      font-style:italic;
    }
    
    input,textarea,select{
      width:100%;
      padding:0.75rem;
      border-radius:var(--radius);
      border:1px solid var(--border);
      background:var(--bg);
      color:var(--text);
      font-family:inherit;
      font-size:1rem;
      transition:border-color 0.2s;
    }
    
    input:focus,textarea:focus,select:focus{
      outline:none;
      border-color:var(--accent);
    }
    
    textarea{
      min-height:120px;
      resize:vertical;
      line-height:1.6;
      white-space:pre-wrap;
    }
    
    button{
      padding:0.75rem 1.5rem;
      border-radius:var(--radius);
      border:none;
      cursor:pointer;
      font-weight:500;
      font-size:0.9375rem;
      transition:all 0.2s;
      font-family:inherit;
    }
    
    .checkbox-group{
      display:flex;
      align-items:center;
      gap:0.5rem;
      margin-top:0.5rem;
    }
    
    .checkbox-group input[type="checkbox"]{
      width:auto;
      margin:0;
    }
    
    .checkbox-group label{
      margin:0;
      font-weight:400;
    }
    
    footer{
      margin:4rem 0 2rem;
      padding:2rem 1.5rem;
      text-align:center;
      border-top:2px solid var(--deep-blue);
    }
    
    .footer-link{
      color:var(--accent);
      font-weight:500;
      text-decoration:none;
      transition:color 0.2s;
    }
    
    .footer-link:hover{
      color:var(--accent-hover);
    }
    
    .suggest-float-btn{
      position:fixed;
      right:1.5rem;
      bottom:1.5rem;
      z-index:200;
      background:linear-gradient(135deg, var(--accent), var(--magenta-dark));
      color:#fff;
      border:none;
      border-radius:999px;
      padding:1rem 1.5rem;
      font-weight:600;
      box-shadow:0 10px 30px rgba(196,30,94,0.4);
      cursor:pointer;
      transition:all 0.2s;
    }
    
    .suggest-float-btn:hover{
      background:linear-gradient(135deg, var(--accent-hover), var(--accent-dark));
      transform:translateY(-2px);
      box-shadow:0 15px 40px rgba(196,30,94,0.5);
    }
    
    .suggest-modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.75);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:210;
      padding:1.5rem;
      backdrop-filter:blur(4px);
    }
    
    .suggest-modal{
      background:var(--panel);
      border-radius:var(--radius);
      padding:2rem;
      max-width:600px;
      width:100%;
      border:1px solid var(--border);
      position:relative;
    }
    
    .suggest-modal h3{
      font-family:'Playfair Display',serif;
      font-size:1.5rem;
      margin-bottom:0.5rem;
    }
    
    .suggest-close{
      position:absolute;
      right:1.5rem;
      top:1.5rem;
      background:transparent;
      border:none;
      color:var(--text-muted);
      font-size:1.5rem;
      cursor:pointer;
      padding:0;
      width:30px;
      height:30px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:4px;
      transition:background 0.2s;
    }
    
    .suggest-close:hover{
      background:var(--bg);
    }
    
    .suggest-btn{
      background:linear-gradient(135deg, var(--accent), var(--magenta-dark));
      color:#fff;
      padding:0.75rem 1.5rem;
      border-radius:var(--radius);
      border:none;
      cursor:pointer;
      font-weight:500;
      transition:all 0.2s;
    }
    
    .suggest-btn:hover{
      background:linear-gradient(135deg, var(--accent-hover), var(--accent-dark));
    }
    
    .suggest-status{
      font-size:0.875rem;
      color:var(--text-muted);
    }
    
    #s-text,#s-text-modal{
      background:var(--bg);
      color:var(--text);
      border:1px solid var(--border);
      font-family:inherit;
      line-height:1.6;
      border-radius:var(--radius);
      padding:0.75rem;
      width:100%;
      min-height:100px;
      max-height:240px;
      white-space:pre-wrap;
    }
    
    .centered-suggest{
      max-width:700px;
      margin:1.5rem auto 0;
      padding:1.5rem;
      background:var(--panel);
      border-radius:var(--radius);
      border:1px solid var(--border);
    }
    
    .tag-pill{
      display:inline-block;
      padding:0.25rem 0.75rem;
      margin-right:0.5rem;
      border-radius:999px;
      background:var(--bg);
      border:1px solid var(--forest-green);
      font-weight:500;
      font-size:0.8125rem;
      color:var(--text-muted);
    }
    
    .image-preview-wrap{
      display:flex;
      gap:0.75rem;
      align-items:center;
      margin-top:0.75rem;
    }
    
    .image-preview-wrap img{
      max-width:120px;
      border-radius:var(--radius);
      border:1px solid var(--border);
      object-fit:cover;
      max-height:90px;
    }
    
    .remove-image-btn{
      background:transparent;
      border:1px solid var(--border);
      color:var(--text-muted);
      padding:0.5rem 1rem;
      border-radius:var(--radius);
      cursor:pointer;
    }
    
    #live-preview{
      margin-top:1rem;
      padding:1rem;
      background:var(--bg);
      border-radius:var(--radius);
      border:1px solid var(--border);
      max-height:400px;
      overflow:auto;
    }
    
    hr{
      border:none;
      border-top:1px solid var(--border);
      margin:1.5rem 0;
    }
    
    .font-title-space{font-family:'Space Grotesk',system-ui,sans-serif;font-weight:700}
    .font-title-merri{font-family:'Merriweather',Georgia,serif;font-weight:700}
    .font-title-inter{font-family:'Inter',system-ui,sans-serif;font-weight:600}
    .font-tags-mont{font-family:'Inter',system-ui,sans-serif;font-weight:500;letter-spacing:0.3px}
    .font-tags-mono{font-family:ui-monospace,monospace;font-weight:600;font-size:0.95rem}
    .md-font-1{font-family:'Inter',system-ui,sans-serif;font-weight:300;line-height:1.65}
    .md-font-2{font-family:'Merriweather',Georgia,serif;font-weight:400;line-height:1.7}
    .md-font-3{font-family:'Space Grotesk',system-ui,sans-serif;font-weight:600;line-height:1.6}
    
    @media(max-width:768px){
      .header-container{
        flex-direction:column;
        gap:1rem;
        text-align:center;
      }
      nav{
        gap:1.5rem;
      }
      .container{
        padding:2rem 1rem;
      }
      .post h1{
        font-size:2rem;
      }
      .controls{
        flex-direction:column;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-container">
      <div id="brand">
        <div id="logo">E</div>
        <div>
          <div id="site-title">Emmiti</div>
          <div class="small">A emmiti blog</div>
        </div>
      </div>
      <nav>
        <a href="#home">Home</a>
        <a href="#about">About</a>
        <a href="#admin">Admin</a>
        <a id="create-post-btn" href="#create-post" style="display:none">Create</a>
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">üåô</button>
      </nav>
    </div>
  </header>

  <main class="container" id="main"></main>

  <footer>
    <div>¬© 2025 Emmiti</div>
    <div class="centered-suggest">
      <form id="suggest-form" class="suggest-form" onsubmit="return submitSuggestionAjax(event)" autocomplete="off" style="display:flex;flex-direction:column;gap:0.75rem">
        <label class="small" for="s-text" style="text-align:left;margin:0 0 0.25rem">Hit me with your ideas, fling your critiques, or summon the post you crave.</label>
        <textarea id="s-text" name="message" placeholder="Short idea, comment or a link..." required></textarea>
        <div style="display:flex;justify-content:flex-end;align-items:center;gap:1rem">
          <div id="suggest-status" class="suggest-status"></div>
          <button type="submit" class="suggest-btn">Send</button>
        </div>
      </form>
    </div>
    <div style="margin-top:1.5rem">
      <a id="twitter" class="footer-link" href="https://twitter.com/askmewhywhat" target="_blank" rel="noopener noreferrer">@askmewhywhat</a>
    </div>
  </footer>

  <button class="suggest-float-btn" id="open-suggest-btn">Suggest</button>

  <div class="suggest-modal-overlay" id="suggest-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="suggest-modal" role="document">
      <button class="suggest-close" id="close-suggest" aria-label="Close suggestion dialog">‚úï</button>
      <h3>Send a suggestion</h3>
      <p class="small" style="margin-bottom:1rem">Short idea, comment or a link...</p>
      <form id="suggest-form-2" class="suggest-form" onsubmit="return submitSuggestionAjax(event)" autocomplete="off" style="display:flex;flex-direction:column;gap:1rem">
        <textarea id="s-text-modal" name="message" placeholder="Short idea, comment or a link..." required></textarea>
        <div style="display:flex;justify-content:flex-end;align-items:center;gap:1rem">
          <div id="suggest-status-modal" class="suggest-status"></div>
          <button type="submit" class="suggest-btn">Send</button>
        </div>
      </form>
    </div>
  </div>

  <template id="hero-tpl">
    <div class="hero fade-in">
      <div class="hero-center">
        <div>
          <h2 class="hero-title">Hero title</h2>
          <div class="hero-sub">Hero excerpt</div>
        </div>
      </div>
    </div>
  </template>

  <template id="tiles-tpl">
    <div class="tiles" aria-live="polite"></div>
  </template>

  <template id="tile-tpl">
    <article class="tile fade-in">
      <div class="bg"></div>
      <div class="meta">
        <h3 class="title">Title</h3>
        <p class="meta-text">meta</p>
      </div>
    </article>
  </template>

  <template id="post-tpl">
    <article class="post fade-in">
      <div class="post-header">
        <a href="#home">‚Üê Back to home</a>
        <div id="post-actions"></div>
      </div>
      <div class="post-cover" id="post-cover">
        <h1 id="post-title">Title</h1>
      </div>
      <div class="post-meta" id="post-meta"></div>
      <div class="share-buttons">
        <button class="share-btn" onclick="shareTwitter()">üê¶ Twitter</button>
        <button class="share-btn" onclick="shareLinkedIn()">üíº LinkedIn</button>
        <button class="share-btn" onclick="copyLink()">üîó Copy Link</button>
      </div>
      <div id="post-content"></div>
    </article>
  </template>

  <template id="admin-tpl">
    <section class="admin-grid fade-in">
      <div class="card">
        <h3>Posts</h3>
        <div class="card-subtitle">Manage your posts ‚Äî feature, edit, or delete them</div>
        <div id="admin-list"></div>
        <hr>
        <div style="display:flex;gap:0.75rem;flex-wrap:wrap">
          <button id="export-btn" class="btn-ghost">Export JSON</button>
          <button id="import-btn" class="btn-ghost">Import JSON</button>
          <button id="sync-btn" class="btn-ghost">Sync to Remote</button>
        </div>
      </div>

      <div class="card">
        <h3 id="admin-form-title">Create / Edit Post</h3>
        <div class="card-subtitle">Fill in the details below to create or update a post</div>
        <input type="hidden" id="edit-id" />
        
        <div class="form-group">
          <label>Title</label>
          <input id="admin-title" placeholder="Enter post title" />
        </div>
        
        <div class="form-group">
          <label>Subtitle / Excerpt</label>
          <input id="admin-excerpt" placeholder="A short, catchy subtitle..." />
          <div class="form-hint">This appears on the home page tiles</div>
        </div>
        
        <div class="form-group">
          <label>Tags</label>
          <input id="admin-tags" placeholder="philosophy, thought, reflection" />
          <div class="form-hint">Separate tags with commas</div>
        </div>
        
        <div class="form-group">
          <label>Cover Image</label>
          <input id="admin-image-file" type="file" accept="image/jpeg,image/png" />
          <div class="form-hint">Used as blurred background in title area</div>
          <div class="image-preview-wrap" id="admin-image-preview-wrap" style="display:none">
            <img id="admin-image-preview" src="" alt="preview" />
            <button id="remove-image-btn" class="remove-image-btn" type="button">Remove</button>
          </div>
        </div>
        
        <div class="form-group">
          <label>Typography Style</label>
          <select id="admin-font">
            <option value="default">Modern (Space Grotesk)</option>
            <option value="fontA">Balanced (Inter & Space Grotesk)</option>
            <option value="fontB">Classic (Merriweather Serif)</option>
            <option value="fontC">Editorial (Inter & Monospace)</option>
          </select>
          <div class="form-hint">Choose the font style for title, tags, and content</div>
        </div>
        
        <div class="form-group">
          <label>Post Series (Optional)</label>
          <input id="admin-series" placeholder="e.g., Part 1 of 3: Philosophy Series" />
          <div class="form-hint">Leave empty if not part of a series</div>
        </div>
        
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="admin-featured" />
            <label for="admin-featured">Mark as Featured</label>
          </div>
          <div class="form-hint">Featured posts get a special badge</div>
        </div>
        
        <div class="form-group">
          <label>Markdown Content</label>
          <textarea id="admin-content" placeholder="# Your Content Here

Write your post in Markdown..."></textarea>
          <div class="form-hint">Supports headings, bold, italic, links, images, and code blocks</div>
        </div>
        
        <div id="live-preview"></div>
        
        <div style="display:flex;gap:0.75rem;margin-top:1.5rem;flex-wrap:wrap">
          <button id="save-btn" class="btn-mag">Save Post</button>
          <button id="clear-btn" class="btn-ghost">Clear Form</button>
          <button id="logout-btn" class="btn-ghost" style="margin-left:auto">Logout</button>
        </div>
        <div id="save-status" style="margin-top:1rem"></div>
      </div>
    </section>
  </template>

  <template id="login-tpl">
    <section class="card fade-in" style="max-width:400px;margin:0 auto">
      <h3>Admin Login</h3>
      <label>Password</label>
      <input id="login-pass" type="password" placeholder="Enter password" />
      <div style="display:flex;gap:0.75rem;margin-top:1.5rem">
        <button id="login-go" class="btn-mag">Login</button>
        <button id="login-cancel" class="btn-ghost">Cancel</button>
      </div>
    </section>
  </template>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" crossorigin="anonymous"></script>

<script>
const SUPABASE_URL = 'https://zowkyufjsbgsqgteqhue.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpvd2t5dWZqc2Jnc3FndGVxaHVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1ODM0ODgsImV4cCI6MjA3MzE1OTQ4OH0.Lc6pGp5d0xwaxaSjr9vm-weOG6i3HHsFRZP70ti7law';

const DEFAULT_POSTS = [
  { id:'hero', title:'Welcome to Emmiti', watermark:'WELCOME', date:'2025-09-09', excerpt:'A markdown-enabled single-file blog.', tags:['intro'], image:'https://placehold.co/1600x900/1b1b1b/ffffff?text=Welcome', content:'# Hello\n\nThis is **Emmiti** ‚Äî write posts in Markdown.\n\n- Item one\n- Item two', fontChoice:'default', featured:true, series:'' },
  { id:'sample', title:'Magenta Dreams', date:'2025-09-08', excerpt:'Styled with magenta & purple.', tags:['style'], image:'https://placehold.co/1200x800/333/fff?text=Magenta+Dreams', content:'### Colors\n\nThis theme uses modern colors for depth and emotion.', fontChoice:'fontA', featured:false, series:'Part 1 of 3: Design Series' }
];
const ADMIN_PASS = 'secret';
const SUGGESTION_EMAIL = 'helloemmiti@gmail.com';

const byId = id => document.getElementById(id);
const q = (s,ctx=document) => ctx.querySelector(s);
function slugify(s){ return String(s||'').toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'').replace(/\-+/g,'-'); }
function savePosts(){ try { localStorage.setItem('blogPosts', JSON.stringify(posts)); } catch(e){ console.error('save', e); } }
function safeLoad(){ try { const raw = localStorage.getItem('blogPosts'); posts = raw ? JSON.parse(raw) : DEFAULT_POSTS.slice(); } catch(e){ console.error('load', e); posts = DEFAULT_POSTS.slice(); } isLoggedIn = localStorage.getItem('isLoggedIn') === 'true'; }

function calculateReadingTime(content){
  if(!content) return 1;
  const words = content.trim().split(/\s+/).length;
  const minutes = Math.ceil(words / 200);
  return minutes;
}

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function fetchRemotePosts(){
  try {
    const { data, error } = await supabaseClient.from('posts').select('*').order('date', { ascending: false });
    if(error){ console.error('supabase fetch error', error); return null; }
    return data || [];
  } catch(err){ console.error('fetchRemotePosts', err); return null; }
}

async function saveRemotePost(post) {
  try {
    const cleanPost = {
      id: post.id,
      title: post.title || '',
      excerpt: post.excerpt || '',
      tags: Array.isArray(post.tags) ? post.tags : [],
      content: post.content || '',
      date: post.date || new Date().toISOString().split('T')[0],
      image: post.image || '',
      fontchoice: post.fontchoice || post.fontChoice || 'default',
      featured: post.featured || false,
      series: post.series || ''
    };

    const { data, error } = await supabaseClient
      .from('posts')
      .upsert([cleanPost], { onConflict: 'id' });

    if (error) {
      console.error("supabase upsert error", error);
      return { ok: false, error };
    }
    return { ok: true, data };
  } catch (err) {
    console.error("saveRemotePost exception:", err);
    return { ok: false, error: err.message };
  }
}

async function deleteRemotePost(postId) {
  try {
    const { error } = await supabaseClient
      .from('posts')
      .delete()
      .eq('id', postId);

    if (error) {
      console.error("supabase delete error", error);
      return { ok: false, error };
    }
    return { ok: true };
  } catch (err) {
    console.error('deleteRemotePost exception:', err);
    return { ok: false, error: err.message };
  }
}

async function syncAllPostsToRemote() {
  let successCount = 0;
  let failCount = 0;
  for (const post of posts) {
    const result = await saveRemotePost(post);
    if (result.ok) successCount++;
    else { failCount++; console.error(`Failed to sync post ${post.id}:`, result.error); }
  }
  return { successCount, failCount, total: posts.length };
}

function readImageFileAsJpegDataURL(file, maxW = 1600, maxH = 900, quality = 0.85){
  return new Promise((resolve, reject) => {
    if(!file) return resolve('');
    const reader = new FileReader();
    reader.onload = function(e){
      const img = new Image();
      img.onload = function(){
        let w = img.width, h = img.height;
        const ratio = w / h;
        if(w > maxW){ w = maxW; h = Math.round(maxW / ratio); }
        if(h > maxH){ h = maxH; w = Math.round(maxH * ratio); }
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0,0,w,h);
        ctx.drawImage(img, 0, 0, w, h);
        try {
          const dataUrl = canvas.toDataURL('image/jpeg', quality);
          resolve(dataUrl);
        } catch(err){
          resolve(e.target.result);
        }
      };
      img.onerror = ()=> resolve(e.target.result);
      img.src = e.target.result;
    };
    reader.onerror = ()=> reject(new Error('Failed reading file'));
    reader.readAsDataURL(file);
  });
}

function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function mdToHtml(md){
  if(!md) return '';
  let text = md.replace(/\r/g,'');
  text = text.replace(/```([\s\S]*?)```/g, (m, code) => `<pre><code>${escapeHtml(code)}</code></pre>`);
  text = text.replace(/!\[(.*?)\]\((.*?)\)/g, '<img alt="$1" src="$2">');
  text = text.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
  text = text.replace(/^### (.*$)/gim, '<h3>$1</h3>');
  text = text.replace(/^## (.*$)/gim, '<h2>$1</h2>');
  text = text.replace(/^# (.*$)/gim, '<h1>$1</h1>');
  text = text.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
  text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
  text = text.replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>');
  const lines = text.split('\n');
  let out = []; let inList = false;
  for(let i=0;i<lines.length;i++){
    const line = lines[i];
    const m = line.match(/^\s*([-\*])\s+(.*)/);
    if(m){ if(!inList){ out.push('<ul>'); inList = true; } out.push('<li>'+m[2]+'</li>'); }
    else { if(inList){ out.push('</ul>'); inList = false; } out.push(line); }
  }
  if(inList) out.push('</ul>');
  text = out.join('\n');
  const parts = text.split(/\n{2,}/).map(p=>p.trim()).filter(Boolean);
  return parts.map(p => {
    if(p.startsWith('<h')||p.startsWith('<ul')||p.startsWith('<pre')||p.startsWith('<img')||p.startsWith('<blockquote')) return p;
    return '<p>'+p+'</p>';
  }).join('\n');
}

function isNew(dateStr, days=7){
  if(!dateStr) return false;
  const t = Date.parse(dateStr);
  if(isNaN(t)) return false;
  return (Date.now() - t) <= days * 24 * 60 * 60 * 1000;
}

function htmlToMarkdownSimple(html){
  if(!html) return '';
  html = html.replace(/<o:p>\s*<\/o:p>/g, '').replace(/<w:[^>]*>[\s\S]*?<\/w:[^>]*>/gi, '').replace(/\s*mso-[^:;]+:[^;"]+;?/gi, '');
  const parser = new DOMParser();
  const doc = parser.parseFromString(`<div id="wrapper">${html}</div>`, 'text/html');
  const wrapper = doc.getElementById('wrapper');
  function nodeToMarkdown(node){
    if(node.nodeType === Node.TEXT_NODE) return node.nodeValue.replace(/\u00A0/g,' ').replace(/\s+/g, ' ');
    const tag = node.tagName ? node.tagName.toLowerCase() : '';
    const style = node.getAttribute && node.getAttribute('style') ? node.getAttribute('style').toLowerCase() : '';
    if(tag === 'br') return '\n';
    if(tag === 'p' || tag === 'div'){ const inner = Array.from(node.childNodes).map(nodeToMarkdown).join(''); return inner.trim() + '\n\n'; }
    if(tag === 'strong' || tag === 'b'){ const inner = Array.from(node.childNodes).map(nodeToMarkdown).join('').trim(); if(!inner) return ''; return ' ' + `**${inner}**` + ' '; }
    if(tag === 'em' || tag === 'i'){ const inner = Array.from(node.childNodes).map(nodeToMarkdown).join('').trim(); if(!inner) return ''; return ' ' + `*${inner}*` + ' '; }
    if(tag === 'span' && style){
      const isItalic = /font-style\s*:\s*italic/.test(style);
      const isBold = /font-weight\s*:\s*(bold|700|800|900)/.test(style);
      const content = Array.from(node.childNodes).map(nodeToMarkdown).join('').trim();
      if(!content) return '';
      if(isBold && isItalic) return ' ' + `***${content}***` + ' ';
      if(isBold) return ' ' + `**${content}**` + ' ';
      if(isItalic) return ' ' + `*${content}*` + ' ';
      return ' ' + content + ' ';
    }
    if(tag === 'h1' || tag === 'h2' || tag === 'h3'){ const level = parseInt(tag.replace('h',''),10); const inner = Array.from(node.childNodes).map(nodeToMarkdown).join('').trim(); return '\n' + '#'.repeat(level) + ' ' + inner + '\n\n'; }
    if(tag === 'ul' || tag === 'ol'){ const items = Array.from(node.children).map((li, idx) => { const content = Array.from(li.childNodes).map(nodeToMarkdown).join('').trim(); if(tag === 'ul') return `- ${content}`; return `${idx+1}. ${content}`; }).join('\n'); return items + '\n\n'; }
    if(tag === 'li'){ const inner = Array.from(node.childNodes).map(nodeToMarkdown).join('').trim(); return `- ${inner}\n`; }
    if(tag === 'a'){ const href = node.getAttribute('href') || ''; const inner = Array.from(node.childNodes).map(nodeToMarkdown).join('').trim(); if(href) return ` [${inner}](${href}) `; return ' ' + inner + ' '; }
    if(tag === 'img'){ const alt = node.getAttribute('alt') || ''; const src = node.getAttribute('src') || ''; return ` ![${alt}](${src}) `; }
    return Array.from(node.childNodes).map(nodeToMarkdown).join('');
  }
  let out = Array.from(wrapper.childNodes).map(nodeToMarkdown).join('');
  out = out.replace(/\s+/g, ' ').replace(/\s+([.,;:!?])/g, '$1').replace(/\n{3,}/g, '\n\n').trim();
  return out;
}
function handlePasteToTextarea(e){
  const ta = e.target;
  const clipboard = e.clipboardData || window.clipboardData;
  if(!clipboard) return;
  const html = clipboard.getData('text/html');
  if(html){
    e.preventDefault();
    const md = htmlToMarkdownSimple(html);
    const start = ta.selectionStart || 0;
    const end = ta.selectionEnd || 0;
    const before = ta.value.slice(0, start);
    const after = ta.value.slice(end);
    ta.value = before + md + after;
    const pos = before.length + md.length;
    ta.selectionStart = ta.selectionEnd = pos;
    ta.dispatchEvent(new Event('input', { bubbles: true }));
    return false;
  }
}

function applyFontChoiceToPostElements(el, fontChoice){
  const titleEl = el.querySelector('#post-title');
  const metaEl = el.querySelector('#post-meta');
  const contentEl = el.querySelector('#post-content');
  titleEl.className = '';
  metaEl.className = 'post-meta';
  contentEl.className = '';
  if(!fontChoice || fontChoice === 'default'){
    titleEl.classList.add('font-title-space');
    metaEl.classList.add('font-tags-mont');
    contentEl.classList.add('md-font-1');
    return;
  }
  if(fontChoice === 'fontA'){
    titleEl.classList.add('font-title-space');
    metaEl.classList.add('font-tags-mont');
    contentEl.classList.add('md-font-1');
  } else if(fontChoice === 'fontB'){
    titleEl.classList.add('font-title-merri');
    metaEl.classList.add('font-tags-mont');
    contentEl.classList.add('md-font-2');
  } else if(fontChoice === 'fontC'){
    titleEl.classList.add('font-title-inter');
    metaEl.classList.add('font-tags-mono');
    contentEl.classList.add('md-font-3');
  } else {
    titleEl.classList.add('font-title-space');
    metaEl.classList.add('font-tags-mont');
    contentEl.classList.add('md-font-1');
  }
}

let posts = [];
let isLoggedIn = false;
let currentPostUrl = '';

function shareTwitter(){
  const text = encodeURIComponent(document.title);
  const url = encodeURIComponent(currentPostUrl);
  window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
}

function shareLinkedIn(){
  const url = encodeURIComponent(currentPostUrl);
  window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`, '_blank');
}

function copyLink(){
  navigator.clipboard.writeText(currentPostUrl).then(()=>{
    alert('Link copied to clipboard!');
  }).catch(()=>{
    const textarea = document.createElement('textarea');
    textarea.value = currentPostUrl;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    alert('Link copied to clipboard!');
  });
}

function toggleTheme(){
  const html = document.documentElement;
  const currentTheme = html.getAttribute('data-theme');
  const newTheme = currentTheme === 'light' ? 'dark' : 'light';
  html.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  const btn = byId('theme-toggle');
  if(btn) btn.textContent = newTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
}

function loadTheme(){
  const saved = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', saved);
  const btn = byId('theme-toggle');
  if(btn) btn.textContent = saved === 'light' ? '‚òÄÔ∏è' : 'üåô';
}

function renderHome(){
  const main = byId('main'); main.innerHTML = '';
  if(posts.length){
    const heroTpl = byId('hero-tpl').content.firstElementChild.cloneNode(true);
    const featured = posts[0];
    heroTpl.querySelector('.hero-title').textContent = featured.title;
    heroTpl.querySelector('.hero-sub').textContent = featured.excerpt || '';
    if(featured.image) {
      heroTpl.querySelector('.hero-center').style.setProperty('--bg-image', `url(${featured.image})`);
    } else {
      heroTpl.querySelector('.hero-center').style.removeProperty('--bg-image');
    }
    heroTpl.addEventListener('click', ()=> location.hash = 'post-'+featured.id);
    main.appendChild(heroTpl);
  }

  const tilesWrap = byId('tiles-tpl').content.firstElementChild.cloneNode(true);
  const tiles = tilesWrap.querySelector('.tiles');
  const tpl = byId('tile-tpl');
  posts.slice(1).forEach((p, idx) => {
    const node = tpl.content.firstElementChild.cloneNode(true);
    node.style.animationDelay = `${idx * 0.1}s`;
    node.querySelector('.title').textContent = p.title;
    const readTime = calculateReadingTime(p.content);
    node.querySelector('.meta-text').textContent = (p.tags && p.tags.length ? p.tags.join(' ‚Ä¢ ') + ' ‚Ä¢ ' : '') + p.date + ` ‚Ä¢ ${readTime} min read`;
    if(p.image) node.querySelector('.bg').style.backgroundImage = `url(${p.image})`;
    
    if(p.featured){
      const badge = document.createElement('div');
      badge.className = 'badge badge-featured';
      badge.textContent = 'FEATURED';
      node.appendChild(badge);
    } else if(p.series){
      const badge = document.createElement('div');
      badge.className = 'badge badge-series';
      badge.textContent = 'SERIES';
      node.appendChild(badge);
    } else if(isNew(p.date, 7)){
      const badge = document.createElement('div');
      badge.className = 'badge badge-new';
      badge.textContent = 'NEW';
      node.appendChild(badge);
    }
    
    node.addEventListener('click', ()=> location.hash = 'post-'+p.id);
    tiles.appendChild(node);
  });
  const wrap = document.createElement('div');
  wrap.className = 'tiles-wrap';
  wrap.appendChild(tiles);
  main.appendChild(wrap);
}

function renderPost(id){
  const p = posts.find(x=>x.id===id);
  if(!p){ renderHome(); return; }
  currentPostUrl = window.location.href;
  const tpl = byId('post-tpl').content.firstElementChild.cloneNode(true);
  tpl.querySelector('#post-title').textContent = p.title;
  const readTime = calculateReadingTime(p.content);
  let metaText = p.date + ` ‚Ä¢ ${readTime} min read`;
  if(p.series) metaText = p.series + ' ‚Ä¢ ' + metaText;
  if(p.tags && p.tags.length) metaText += ' ‚Ä¢ ' + p.tags.map(t => `<span class="tag-pill">${t}</span>`).join('');
  tpl.querySelector('#post-meta').innerHTML = metaText;
  const postCover = tpl.querySelector('#post-cover');
  if(p.image && postCover){
    postCover.style.setProperty('--post-bg-image', `url(${p.image})`);
  } else if(postCover){
    postCover.style.removeProperty('--post-bg-image');
  }

  tpl.querySelector('#post-content').innerHTML = mdToHtml(p.content || '');
  applyFontChoiceToPostElements(tpl, p.fontChoice);

  const actions = tpl.querySelector('#post-actions');
  actions.innerHTML = '';
  if(isLoggedIn){
    const edit = document.createElement('button'); edit.className = 'btn-ghost'; edit.textContent = 'Edit';
    edit.onclick = ()=> { renderAdmin(); setTimeout(()=> loadIntoForm(p.id), 120); };
    const del = document.createElement('button'); del.className = 'btn-mag'; del.textContent = 'Delete';
    del.onclick = async ()=> {
      if(confirm('Delete this post?')) {
        posts = posts.filter(x=>x.id!==p.id);
        savePosts();
        const res = await deleteRemotePost(p.id);
        if(!res.ok) console.warn('Remote delete failed', res.error);
        location.hash = 'home';
      }
    };
    actions.appendChild(edit); actions.appendChild(del);
  }

  byId('main').innerHTML = ''; byId('main').appendChild(tpl);
  window.scrollTo(0,0);
}

function renderAbout(){
  const template = document.createElement('section');
  template.className = 'post fade-in';
  template.innerHTML = `<h2>About</h2><p class="muted">I am not here to fit into your comfort, nor to overturn it. I dwell in fear, in doubt, in suffering, in the abyss that stares back and so do you, though your denial serves the greater mystery. My joy is not in happiness but in intensity. To converse with me is to risk not comfort but confrontation, and perhaps to find the courage you never knew you carried. I write as I live close to the bone, tracing the raw and naked details of people, of films, of fleeting moments that cut deeper than appearances.</p>`;
  byId('main').innerHTML = ''; byId('main').appendChild(template);
}

function showAdminImagePreview(dataUrl){
  const wrap = byId('admin-image-preview-wrap');
  const img = byId('admin-image-preview');
  if(!wrap || !img) return;
  if(dataUrl){
    img.src = dataUrl;
    img.setAttribute('data-src', dataUrl);
    wrap.style.display = 'flex';
  } else {
    img.src = '';
    img.removeAttribute('data-src');
    wrap.style.display = 'none';
  }
}

function loadIntoForm(id){
  const p = posts.find(x=>x.id===id); if(!p){ alert('Post not found'); return; }
  byId('edit-id').value = p.id;
  byId('admin-title').value = p.title || '';
  byId('admin-excerpt').value = p.excerpt || '';
  byId('admin-tags').value = (p.tags||[]).join(', ');
  showAdminImagePreview(p.image || '');
  const fileInput = byId('admin-image-file'); if(fileInput) fileInput.value = '';
  byId('admin-content').value = p.content || '';
  byId('admin-font').value = p.fontChoice || 'default';
  byId('admin-series').value = p.series || '';
  byId('admin-featured').checked = p.featured || false;
  byId('admin-form-title').textContent = 'Edit Post';
  location.hash = 'admin';
  setTimeout(()=> window.scrollTo({top:0,behavior:'smooth'}), 80);
  setTimeout(()=> {
    const ta = byId('admin-content'); const live = byId('live-preview');
    if(ta && live) live.innerHTML = mdToHtml(ta.value || '');
  }, 120);
}

async function adminSave(){
  const editId = (byId('edit-id').value || '').trim();
  const title = (byId('admin-title').value || '').trim();
  if(!title){ alert('Title required'); return; }
  const excerpt = (byId('admin-excerpt').value || '').trim();
  const tags = (byId('admin-tags').value || '').split(',').map(s=>s.trim()).filter(Boolean);

  const previewImg = byId('admin-image-preview');
  const image = previewImg && previewImg.getAttribute('data-src') ? previewImg.getAttribute('data-src') : '';

  const content = (byId('admin-content').value || '').trim();
  const fontChoice = byId('admin-font').value || 'default';
  const series = (byId('admin-series').value || '').trim();
  const featured = byId('admin-featured').checked;
  const dateStr = new Date().toISOString().split('T')[0];

  if(editId){
    const idx = posts.findIndex(x=>x.id===editId);
    if(idx === -1){ alert('Post not found'); return; }
    posts[idx].title = title;
    posts[idx].excerpt = excerpt;
    posts[idx].tags = tags;
    posts[idx].image = image;
    posts[idx].content = content;
    posts[idx].fontChoice = fontChoice;
    posts[idx].fontchoice = fontChoice;
    posts[idx].series = series;
    posts[idx].featured = featured;
    posts[idx].date = dateStr;
    savePosts();
    const res = await saveRemotePost(posts[idx]);
    if(!res.ok) alert('Updated locally but remote save failed. Check console.');
    else alert('Post updated (local & remote).');
    renderAdmin();
  } else {
    const id = slugify(title) || Date.now().toString();
    const newPost = { id, title, watermark: title.replace(/\s+/g,''), date: dateStr, excerpt, tags, image, content, fontChoice, fontchoice: fontChoice, series, featured };
    if(posts.length === 0) posts.unshift(newPost);
    else posts.splice(1,0,newPost);
    savePosts();
    const res = await saveRemotePost(newPost);
    if(!res.ok) alert('Created locally but failed to publish remotely ‚Äî check console.');
    else alert('Post created (local & remote).');
    renderAdmin();
  }
}

async function submitSuggestionAjax(e){
  e.preventDefault();
  const ta = byId('s-text') || byId('s-text-modal');
  const status = byId('suggest-status') || byId('suggest-status-modal');
  if(!ta) return false;
  const text = (ta.value || '').trim();
  if(!text){ status.textContent = 'Write something first.'; return false; }
  status.style.color = ''; status.textContent = 'Sending‚Ä¶';
  const endpoint = 'https://formsubmit.co/ajax/helloemmiti@gmail.com';
  const payload = { message: text, _subject: 'Emmiti suggestion', _captcha: 'false' };
  try{
    const res = await fetch(endpoint, { method:'POST', headers:{ 'Content-Type':'application/json','Accept':'application/json' }, body: JSON.stringify(payload) });
    const json = await res.json();
    if(res.ok && json.success !== false){
      status.style.color = ''; status.textContent = 'Sent ‚Äî thanks!';
      ta.value = '';
      setTimeout(()=> status.textContent = '', 2500);
      setTimeout(()=> closeSuggestModal(), 900);
    } else { throw new Error((json.message || 'Send failed')); }
  }catch(err){
    console.error('Suggest send', err);
    status.style.color = '#ffb3b3';
    status.textContent = 'Send failed ‚Äî opening mail client as fallback.';
    const body = encodeURIComponent(`Suggestion from site\n\n---\n${text}`);
    const subject = encodeURIComponent('Emmiti site suggestion');
    setTimeout(()=> { window.location.href = `mailto:${SUGGESTION_EMAIL}?subject=${subject}&body=${body}`; }, 800);
  }
  return false;
}

function openSuggestModal(){
  const overlay = byId('suggest-modal'); if(!overlay) return;
  overlay.style.display = 'flex'; overlay.setAttribute('aria-hidden','false');
  const ta = byId('s-text-modal'); if(ta) ta.focus();
}
function closeSuggestModal(){
  const overlay = byId('suggest-modal'); if(!overlay) return;
  overlay.style.display = 'none'; overlay.setAttribute('aria-hidden','true');
  const status = byId('suggest-status-modal'); if(status) status.textContent = '';
}

function renderAdmin(){
  const main = byId('main'); main.innerHTML = '';
  if(!isLoggedIn){
    const login = byId('login-tpl').content.firstElementChild.cloneNode(true);
    main.appendChild(login);
    byId('login-go').onclick = ()=> {
      const val = byId('login-pass').value || '';
      if(val === ADMIN_PASS){ isLoggedIn = true; localStorage.setItem('isLoggedIn','true'); updateUI(); renderAdmin(); }
      else alert('Incorrect password');
    };
    byId('login-cancel').onclick = ()=> location.hash = 'home';
    return;
  }

  const admin = byId('admin-tpl').content.firstElementChild.cloneNode(true);
  main.appendChild(admin);

  const list = byId('admin-list');
  list.innerHTML = '';
  posts.forEach((p, idx) => {
    const item = document.createElement('div'); item.className = 'post-item';
    const left = document.createElement('div'); left.className = 'left';
    let badges = '';
    if(p.featured) badges = '<span class="badge badge-featured" style="position:static;margin-right:0.5rem">FEATURED</span>';
    else if(p.series) badges = '<span class="badge badge-series" style="position:static;margin-right:0.5rem">SERIES</span>';
    left.innerHTML = `<div style="font-weight:700">${badges}${p.title}</div><div class="small" style="color:var(--text-muted)">${p.date} ‚Ä¢ ${p.tags ? p.tags.join(', ') : ''}</div>`;
    const controls = document.createElement('div'); controls.className = 'controls';
    const feat = document.createElement('button'); feat.className='btn-ghost'; feat.textContent='Feature';
    feat.onclick = ()=> { posts.splice(idx,1); posts.unshift(p); savePosts(); renderAdmin(); };
    const edit = document.createElement('button'); edit.className='btn-ghost'; edit.textContent='Edit';
    edit.onclick = ()=> { loadIntoForm(p.id); };
    const del = document.createElement('button'); del.className='btn-mag'; del.textContent='Delete';
    del.onclick = async ()=> { if(confirm('Delete?')){ posts = posts.filter(x=>x.id!==p.id); savePosts(); const res = await deleteRemotePost(p.id); if(!res.ok) console.warn('remote delete failed', res.error); renderAdmin(); location.hash='home'; } };
    controls.appendChild(feat); controls.appendChild(edit); controls.appendChild(del);
    item.appendChild(left); item.appendChild(controls);
    list.appendChild(item);
  });

  byId('save-btn').onclick = ()=> adminSave();
  byId('clear-btn').onclick = ()=> {
    byId('edit-id').value=''; byId('admin-title').value=''; byId('admin-excerpt').value=''; byId('admin-tags').value=''; byId('admin-content').value=''; byId('admin-font').value='default'; byId('admin-series').value=''; byId('admin-featured').checked=false;
    byId('admin-form-title').textContent = 'Create / Edit Post';
    showAdminImagePreview('');
    const fileInput = byId('admin-image-file'); if(fileInput) fileInput.value = '';
    const live = byId('live-preview'); if(live) live.innerHTML = '';
  };
  byId('logout-btn').onclick = ()=> {
    if(confirm('Logout?')){ isLoggedIn = false; localStorage.setItem('isLoggedIn','false'); updateUI(); location.hash='home'; }
  };

  byId('export-btn').onclick = ()=> {
    const data = JSON.stringify(posts, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'emmiti-posts.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };
  byId('import-btn').onclick = ()=> {
    const inp = document.createElement('input'); inp.type = 'file'; inp.accept='.json,application/json';
    inp.onchange = (e)=> {
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader(); reader.onload = async ()=> {
        try {
          const data = JSON.parse(reader.result);
          if(!Array.isArray(data)) throw new Error('Invalid JSON (expected array).');
          posts = data; savePosts();
          for(const p of posts){ await saveRemotePost(p).catch(()=>{}); }
          alert('Imported posts'); renderAdmin();
        } catch(err){ alert('Import failed: '+err.message); }
      }; reader.readAsText(f);
    };
    inp.click();
  };

  const syncBtn = byId('sync-btn');
  if(syncBtn){
    syncBtn.onclick = async ()=> {
      const status = byId('save-status');
      if(status) status.textContent = 'Syncing...';
      const res = await syncAllPostsToRemote();
      if(status) status.textContent = `Sync complete ‚Äî ${res.successCount} succeeded, ${res.failCount} failed.`;
      setTimeout(()=> { if(status) status.textContent = ''; }, 4000);
    };
  }

  const adminContentTa = byId('admin-content');
  if(adminContentTa){
    adminContentTa.addEventListener('paste', handlePasteToTextarea);
    const live = byId('live-preview');
    const updatePreview = ()=> {
      if(!live) return;
      live.innerHTML = mdToHtml(adminContentTa.value || '');
    };
    adminContentTa.addEventListener('input', updatePreview);
    updatePreview();
  }

  const fileInput = byId('admin-image-file');
  if(fileInput){
    fileInput.addEventListener('change', async (ev)=>{
      const f = ev.target.files[0];
      if(!f){ showAdminImagePreview(''); return; }
      try{
        const preview = await readImageFileAsJpegDataURL(f, 1600, 900, 0.8);
        showAdminImagePreview(preview);
      }catch(err){
        console.error('preview error', err);
        const r = new FileReader();
        r.onload = ()=> showAdminImagePreview(r.result);
        r.readAsDataURL(f);
      }
    });
  }
  const removeBtn = byId('remove-image-btn');
  if(removeBtn){
    removeBtn.onclick = ()=>{
      showAdminImagePreview('');
      const fi = byId('admin-image-file'); if(fi) fi.value = '';
    };
  }
}

function router(){
  const hash = (location.hash || '#home').replace(/^#/,'');
  if(!hash || hash === 'home'){ renderHome(); return; }
  if(hash === 'about'){ renderAbout(); return; }
  if(hash === 'admin'){ renderAdmin(); return; }
  if(hash === 'create-post'){ if(!isLoggedIn){ location.hash='admin'; return; } renderAdmin(); byId('edit-id').value=''; byId('admin-title').value=''; byId('admin-tags').value=''; byId('admin-image-file').value=''; byId('admin-content').value=''; byId('admin-series').value=''; byId('admin-featured').checked=false; return; }
  if(hash.startsWith('post-')){ renderPost(hash.replace('post-','')); return; }
  renderHome();
}

function updateUI(){
  const create = byId('create-post-btn'); if(create) create.style.display = isLoggedIn? 'inline-block':'none';
}

window.addEventListener('hashchange', router);
window.addEventListener('load', async () => {
  loadTheme();
  try {
    const remote = await fetchRemotePosts();
    if (remote && remote.length) {
      posts = remote.map(r => ({
        id: r.id,
        title: r.title,
        excerpt: r.excerpt,
        tags: Array.isArray(r.tags) ? r.tags : (r.tags ? String(r.tags).split(',').map(s => s.trim()) : []),
        image: r.image,
        content: r.content,
        fontchoice: r.fontchoice || r.fontChoice || 'default',
        fontChoice: r.fontchoice || r.fontChoice || 'default',
        featured: r.featured || false,
        series: r.series || '',
        date: r.date
          ? (typeof r.date === 'string' ? r.date : new Date(r.date).toISOString().split('T')[0])
          : (r.created_at ? r.created_at.split('T')[0] : new Date().toISOString().split('T')[0])
      }));
      savePosts();
    } else {
      safeLoad();
    }
  } catch (err) {
    console.error('init fetch error', err);
    safeLoad();
  }

  updateUI();
  const twitter = byId('twitter'); if (twitter) twitter.href = 'https://twitter.com/askmewhywhat';
  const createBtn = byId('create-post-btn'); if (createBtn) createBtn.addEventListener('click', e => { e.preventDefault(); location.hash = 'create-post'; });
  const openBtn = byId('open-suggest-btn'); if (openBtn) openBtn.addEventListener('click', openSuggestModal);
  const closeBtn = byId('close-suggest'); if (closeBtn) closeBtn.addEventListener('click', closeSuggestModal);
  const overlay = byId('suggest-modal'); if (overlay) overlay.addEventListener('click', (ev) => { if (ev.target === overlay) closeSuggestModal(); });
  const themeBtn = byId('theme-toggle'); if(themeBtn) themeBtn.addEventListener('click', toggleTheme);
  router();
});
</script>
</body>
</html>